name: Publish to npm

on:
  workflow_dispatch:
    inputs:
      release-type:
        description: "Release type"
        required: true
        default: "stable"
        type: choice
        options:
          - stable
          - dev
  workflow_run:
    workflows:
      - "CI Weekly"
    branches:
      - develop
    types:
      - completed

env:
  RELEASE_TYPE: ${{ github.event_name == 'workflow_run' && 'dev' || inputs.release-type }}

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: upload

    permissions:
      id-token: write # Required by npm OIDC trusted publishing
      contents: read
      packages: read

    steps:
      - name: Checkout branch
        uses: actions/checkout@v5
        with:
          ref: ${{ env.RELEASE_TYPE == 'stable' && 'master' || 'develop' }}
          fetch-depth: "0"

      - name: Setup git
        run: |
          git config user.name "kendo-bot"
          git config user.email "kendouiteam@progress.com"

      - name: Merge develop to master
        if: env.RELEASE_TYPE == 'stable'
        run: |
          git fetch --quiet
          git reset --hard origin/master
          git merge --ff-only --quiet origin/develop

      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: 22.x
          registry-url: "https://registry.npmjs.org"

      - name: Install
        run: npm ci --no-audit --no-fund

      - name: Build themes for dist
        run: |
          npm run sass:dist
          npm run docs

      - name: Lerna publish (stable)
        if: env.RELEASE_TYPE == 'stable'
        run: |
          npx lerna publish --conventional-commits --conventional-graduate --create-release github --force-publish --exact
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Lerna publish (dev)
        if: env.RELEASE_TYPE == 'dev'
        run: |
          npx lerna publish --conventional-commits --conventional-prerelease --create-release github --preid dev --dist-tag dev --allow-branch develop --force-publish --exact --yes
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Mark checks as successful
        run: |
          commit=$(git rev-parse HEAD)
          ./build/mark-checks.sh $commit
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Push to GitHub
        if: env.RELEASE_TYPE == 'stable'
        run: |
          git push origin master --tags --quiet > /dev/null 2>&1
          git push origin master:develop --quiet > /dev/null 2>&1
